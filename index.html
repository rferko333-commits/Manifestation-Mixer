<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifestation Audio Mixer</title>
    <style>
        :root { --primary: #8b5cf6; --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        h1, h2 { text-align: center; color: var(--primary); }
        
        .panel { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .control-group { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        label { font-weight: bold; width: 150px; }
        input[type=range] { flex-grow: 1; margin: 0 10px; cursor: pointer; }
        
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; margin: 5px; }
        button:hover { opacity: 0.9; }
        button.stop { background: #ef4444; }
        button.record { background: #ef4444; }
        button.recording { animation: pulse 1.5s infinite; }
        
        select { padding: 8px; border-radius: 4px; background: #334155; color: white; border: none; }
        
        .info-box { background: #334155; padding: 15px; border-radius: 8px; font-size: 0.9em; margin-top: 10px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Manifestation Mixer</h1>

    <!-- 1. The Guide -->
    <div class="panel">
        <h2>Frequency Guide</h2>
        <div class="info-box">
            <strong>Binaural Brainwaves:</strong><br>
            Delta (1-4Hz): Deep Sleep | Theta (4-8Hz): Meditation/Hypnosis | Alpha (8-14Hz): Relaxation | Beta (14-30Hz): Focus<br><br>
            <strong>Solfeggio Frequencies:</strong><br>
            396Hz: Remove Fear | 417Hz: Facilitate Change | 528Hz: Miracles/DNA | 639Hz: Relationships | 741Hz: Intuition
        </div>
    </div>

    <!-- 2. Voice / Mic Input -->
    <div class="panel">
        <h2>1. Voice Layer</h2>
        <p>Record your affirmations. (Headphones recommended to prevent echo).</p>
        <div class="control-group">
            <button id="btnRecord" class="record">ðŸŽ¤ Start Recording Mic</button>
            <span id="recordStatus">Not Recording</span>
        </div>
        <div class="control-group">
            <label>Voice Volume</label>
            <input type="range" id="volVoice" min="0" max="2" step="0.1" value="1">
        </div>
    </div>

    <!-- 3. Binaural Generator -->
    <div class="panel">
        <h2>2. Binaural Beats Engine</h2>
        <div class="control-group">
            <label>Preset</label>
            <select id="presetSelect" onchange="applyPreset()">
                <option value="custom">Custom Settings</option>
                <option value="theta">Deep Meditation (Theta 6Hz)</option>
                <option value="alpha">Relaxed Focus (Alpha 10Hz)</option>
                <option value="solf528">Miracle Tone (528Hz)</option>
                <option value="solf417">Clear Negativity (417Hz)</option>
            </select>
        </div>
        <div class="control-group">
            <label>Base Tone (Hz)</label>
            <input type="number" id="baseFreq" value="200" style="width: 60px; padding: 5px;">
            <input type="range" id="baseSlider" min="50" max="900" value="200">
        </div>
        <div class="control-group">
            <label>Beat Diff (Hz)</label>
            <input type="number" id="beatFreq" value="6" style="width: 60px; padding: 5px;">
            <input type="range" id="beatSlider" min="0.5" max="40" step="0.5" value="6">
        </div>
        <div class="control-group">
            <label>Beat Volume</label>
            <input type="range" id="volBinaural" min="0" max="1" step="0.05" value="0.5">
        </div>
    </div>

    <!-- 4. Background Atmosphere -->
    <div class="panel">
        <h2>3. Atmosphere</h2>
        <div class="control-group">
            <label>Noise Type</label>
            <select id="noiseType">
                <option value="brown">Brown Noise (Deep/Rumbling)</option>
                <option value="pink">Pink Noise (Balanced/Rain-like)</option>
                <option value="white">White Noise (Static)</option>
            </select>
        </div>
        <div class="control-group">
            <label>Noise Volume</label>
            <input type="range" id="volNoise" min="0" max="0.5" step="0.01" value="0.1">
        </div>
    </div>

    <!-- 5. Master Controls -->
    <div class="panel" style="text-align: center;">
        <h2>Master Control</h2>
        <button id="btnPlay" onclick="togglePlay()">â–¶ Play Preview</button>
        <button id="btnExport" onclick="startExport()">ðŸ’¾ Record & Download Mix</button>
        <p id="exportStatus" style="font-size: 0.9em; margin-top: 10px; color: #94a3b8;"></p>
    </div>
</div>

<script>
    let audioCtx, masterGain;
    let oscLeft, oscRight, panLeft, panRight, gainBinaural;
    let noiseNode, gainNoise;
    let micStream, micNode, gainMic;
    let isPlaying = false;
    let mediaRecorder, chunks = [];

    // --- Audio Initialization ---
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
        }
    }

    // --- 1. Binaural Beats Logic ---
    function startBinaural() {
        // Create Left Ear
        oscLeft = audioCtx.createOscillator();
        panLeft = audioCtx.createStereoPanner();
        panLeft.pan.value = -1; // Hard Left

        // Create Right Ear
        oscRight = audioCtx.createOscillator();
        panRight = audioCtx.createStereoPanner();
        panRight.pan.value = 1; // Hard Right

        gainBinaural = audioCtx.createGain();
        gainBinaural.gain.value = document.getElementById('volBinaural').value;

        // Routing
        oscLeft.connect(panLeft).connect(gainBinaural);
        oscRight.connect(panRight).connect(gainBinaural);
        gainBinaural.connect(masterGain);

        updateFrequencies();
        oscLeft.start();
        oscRight.start();
    }

    function updateFrequencies() {
        if(!oscLeft) return;
        const base = parseFloat(document.getElementById('baseFreq').value);
        const beat = parseFloat(document.getElementById('beatFreq').value);
        
        oscLeft.frequency.value = base;
        oscRight.frequency.value = base + beat;
    }

    // Link Sliders to Inputs
    document.getElementById('baseSlider').oninput = function() {
        document.getElementById('baseFreq').value = this.value;
        updateFrequencies();
    }
    document.getElementById('beatSlider').oninput = function() {
        document.getElementById('beatFreq').value = this.value;
        updateFrequencies();
    }
    document.getElementById('volBinaural').oninput = function() {
        if(gainBinaural) gainBinaural.gain.value = this.value;
    }

    // --- 2. Noise Logic ---
    function startNoise() {
        const bufferSize = audioCtx.sampleRate * 2; // 2 seconds
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        const type = document.getElementById('noiseType').value;

        if (type === 'white') {
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        } else if (type === 'pink') {
            let b0, b1, b2, b3, b4, b5, b6;
            b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
            for (let i = 0; i < bufferSize; i++) {
                let white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168981;
                data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                data[i] *= 0.11; 
                b6 = white * 0.115926;
            }
        } else { // Brown
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                let white = Math.random() * 2 - 1;
                data[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = data[i];
                data[i] *= 3.5; 
            }
        }

        noiseNode = audioCtx.createBufferSource();
        noiseNode.buffer = buffer;
        noiseNode.loop = true;
        
        gainNoise = audioCtx.createGain();
        gainNoise.gain.value = document.getElementById('volNoise').value;
        
        noiseNode.connect(gainNoise).connect(masterGain);
        noiseNode.start();
    }

    document.getElementById('volNoise').oninput = function() {
        if(gainNoise) gainNoise.gain.value = this.value;
    }

    // --- 3. Mic Logic ---
    document.getElementById('btnRecord').onclick = async function() {
        initAudio();
        if (this.classList.contains('recording')) {
            // Stop Mic
            if (micStream) micStream.getTracks().forEach(track => track.stop());
            this.classList.remove('recording');
            this.innerText = "ðŸŽ¤ Start Recording Mic";
            document.getElementById('recordStatus').innerText = "Mic Off";
            return;
        }

        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            micNode = audioCtx.createMediaStreamSource(micStream);
            gainMic = audioCtx.createGain();
            gainMic.gain.value = document.getElementById('volVoice').value;
            
            // Connect Mic to Master
            micNode.connect(gainMic).connect(masterGain);
            
            this.classList.add('recording');
            this.innerText = "â¹ Stop Recording Mic";
            document.getElementById('recordStatus').innerText = "Mic Live & Monitoring";
        } catch (e) {
            alert("Error accessing microphone: " + e.message);
        }
    };

    document.getElementById('volVoice').oninput = function() {
        if(gainMic) gainMic.gain.value = this.value;
    }

    // --- 4. Master Logic ---
    function togglePlay() {
        initAudio();
        if (isPlaying) {
            // Stop
            if(oscLeft) oscLeft.stop();
            if(oscRight) oscRight.stop();
            if(noiseNode) noiseNode.stop();
            document.getElementById('btnPlay').innerText = "â–¶ Play Preview";
            isPlaying = false;
        } else {
            // Start
            if(audioCtx.state === 'suspended') audioCtx.resume();
            startBinaural();
            startNoise();
            document.getElementById('btnPlay').innerText = "â¹ Stop Preview";
            isPlaying = true;
        }
    }

    // --- 5. Export Logic (The "Download" Button) ---
    function startExport() {
        initAudio();
        // Setup Destination Stream for Recording
        const dest = audioCtx.createMediaStreamDestination();
        
        // Re-route everything to Destination AND Speakers
        if(gainBinaural) { gainBinaural.connect(dest); }
        if(gainNoise) { gainNoise.connect(dest); }
        if(gainMic) { gainMic.connect(dest); }
        
        mediaRecorder = new MediaRecorder(dest.stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = e => {
            const blob = new Blob(chunks, { 'type' : 'audio/wav; codecs=MS_PCM' });
            const audioURL = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = audioURL;
            a.download = "manifestation_mix.wav";
            a.click();
            document.getElementById('exportStatus').innerText = "Download Ready!";
        };

        // Start recording
        mediaRecorder.start();
        document.getElementById('exportStatus').innerText = "ðŸ”´ Recording Mix... Press 'Stop Preview' to finish.";
        
        // Ensure audio is playing
        if(!isPlaying) togglePlay();
        
        // Override the Stop button to trigger download
        const oldStop = document.getElementById('btnPlay').onclick;
        document.getElementById('btnPlay').onclick = function() {
            mediaRecorder.stop();
            togglePlay(); // Stop sounds
            // Reset button logic
            document.getElementById('btnPlay').onclick = togglePlay; 
        }
    }

    // --- Presets ---
    function applyPreset() {
        const val = document.getElementById('presetSelect').value;
        if(val === 'theta') { setFreqs(200, 6); }
        else if(val === 'alpha') { setFreqs(200, 10); }
        else if(val === 'solf528') { setFreqs(528, 0); } // 0 Beat means Isochronic/Pure tone
        else if(val === 'solf417') { setFreqs(417, 0); }
    }

    function setFreqs(base, beat) {
        document.getElementById('baseFreq').value = base;
        document.getElementById('baseSlider').value = base;
        document.getElementById('beatFreq').value = beat;
        document.getElementById('beatSlider').value = beat;
        updateFrequencies();
    }
</script>

</body>
</html>
